<%# Step 4: Confirm & Price %>
<div data-book-scan-target="confirmStep" class="hidden">
  <div class="mb-4 flex justify-between items-center">
    <h2 class="text-xl font-semibold">Confirm Book Details</h2>
    <button type="button"
            data-action="click->book-scan#backToMethodSelection"
            class="text-gray-600 hover:text-gray-800">
      &larr; Start Over
    </button>
  </div>

  <%# Duplicate Warning %>
  <div data-book-scan-target="duplicateWarning" class="hidden bg-amber-100 border border-amber-400 text-amber-800 px-4 py-3 rounded mb-4">
    <p class="font-medium">You already have this book listed.</p>
    <p class="text-sm">You can still list another copy if you have multiple.</p>
  </div>

  <%= form_with model: book, url: books_path, class: "space-y-4", data: { book_scan_target: "form" } do |form| %>
    <%# Hidden fields for scanned data %>
    <%= form.hidden_field :isbn_10, data: { book_scan_target: "isbn10Field" } %>
    <%= form.hidden_field :isbn_13, data: { book_scan_target: "isbn13Field" } %>
    <%= form.hidden_field :cover_image_url, data: { book_scan_target: "coverUrlField" } %>
    <%= form.hidden_field :publisher, data: { book_scan_target: "publisherField" } %>
    <%= form.hidden_field :publication_year, data: { book_scan_target: "publicationYearField" } %>
    <%= form.hidden_field :page_count, data: { book_scan_target: "pageCountField" } %>
    <%= form.hidden_field :identified_by, data: { book_scan_target: "identifiedByField" } %>

    <%# Book Preview %>
    <div class="flex gap-4 p-4 bg-gray-50 rounded-lg" data-book-scan-target="bookPreview">
      <img data-book-scan-target="coverImage"
           src=""
           alt="Book cover"
           class="w-24 h-auto rounded shadow hidden">
      <div class="flex-1">
        <p class="font-bold text-lg" data-book-scan-target="previewTitle"></p>
        <p class="text-gray-600" data-book-scan-target="previewAuthor"></p>
        <p class="text-sm text-gray-500" data-book-scan-target="previewPublisher"></p>
      </div>
    </div>

    <%# Editable Fields %>
    <div>
      <%= form.label :title, class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.text_field :title, required: true, data: { book_scan_target: "titleField" }, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
    </div>

    <div>
      <%= form.label :author, class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.text_field :author, required: true, data: { book_scan_target: "authorField" }, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
    </div>

    <div>
      <%= form.label :description, class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.text_area :description, rows: 3, data: { book_scan_target: "descriptionField" }, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
    </div>

    <div>
      <%= form.label :price, "Your Price", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <div class="flex items-center">
        <span class="text-gray-500 mr-2">$</span>
        <%= form.number_field :price, step: "0.01", min: "0.01", required: true, class: "w-32 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
      </div>
    </div>

    <%# Condition Photos Section %>
    <details class="border border-gray-200 rounded-lg">
      <summary class="px-4 py-3 cursor-pointer font-medium text-gray-700 hover:bg-gray-50">
        Add Condition Photos (Optional)
      </summary>
      <div class="p-4 border-t border-gray-200">
        <div data-controller="book-photo"
             data-book-photo-mode-value="condition"
             data-book-photo-max-photos-value="5">
          
          <div class="flex gap-3 mb-4">
            <button type="button"
                    data-action="click->book-photo#startCamera"
                    class="flex-1 py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm">
              Take Photo
            </button>
            <button type="button"
                    data-action="click->book-photo#selectFromGallery"
                    class="flex-1 py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm">
              Choose File
            </button>
          </div>

          <video data-book-photo-target="video" autoplay playsinline class="hidden w-full rounded-lg mb-2"></video>
          <canvas data-book-photo-target="canvas" class="hidden"></canvas>
          
          <input type="file"
                 accept="image/*"
                 multiple
                 name="book[condition_photos][]"
                 data-book-photo-target="fileInput"
                 data-action="change->book-photo#handleFileSelect"
                 class="hidden">

          <div data-book-photo-target="capturedPhotos" class="mt-3"></div>

          <p class="text-xs text-gray-500 mt-2">
            Add photos showing the book's actual condition (cover, spine, any damage). Max 5 photos.
          </p>
        </div>
      </div>
    </details>

    <div class="pt-4">
      <%= form.submit "List Book for Sale", class: "w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors cursor-pointer" %>
    </div>
  <% end %>
</div>
